generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["driverAdapters"]
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

enum WorkspaceRole {
    ADMIN
    MEMBER
}

enum TaskStatus {
    TODO
    IN_PROGRESS
    DONE
}

enum TaskType {
    TASK
    BUG
    FEATURE
    IMPROVEMENT
    OTHER
    MANUSCRIPT
    BOOK_DRAFT
    PUBLISHING_STAGE
}

enum ProjectStatus {
    ACTIVE
    PLANNING
    COMPLETED
    ON_HOLD
    CANCELLED
}

enum Priority {
    LOW
    MEDIUM
    HIGH
}

enum ProjectType {
    HYBRID
    ASSISTED
}

model User {
    id        String   @id
    name      String
    email     String   @unique
    image     String   @default("")
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    workspaces      WorkspaceMember[]
    projects        AuthorProject[]         @relation("ProjectOwner")
    tasks           AuthorTask[]            @relation("TaskAssignee")
    comments        Comment[]
    ownedWorkspaces Workspace[]
    ProjectMember   ProjectMember[]
}

model Workspace {
    id          String   @id
    name        String
    slug        String   @unique
    description String?
    settings    Json     @default("{}")
    ownerId     String
    createdAt   DateTime @default(now())
    image_url   String   @default("")
    updatedAt   DateTime @updatedAt

    members  WorkspaceMember[]
    projects AuthorProject[]
    owner    User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model WorkspaceMember {
    id          String        @id @default(uuid())
    userId      String
    workspaceId String
    message     String        @default("")
    role        WorkspaceRole @default(MEMBER)
    user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@unique([userId, workspaceId]) // prevent duplicate membership
}

model AuthorProject {
    id              String          @id @default(uuid())
    name            String
    description     String?
    priority        Priority        @default(MEDIUM)
    status          ProjectStatus   @default(ACTIVE)
    type            ProjectType     @default(HYBRID)
    start_date      DateTime?
    end_date        DateTime?
    team_lead       String
    workspaceId     String
    progress        Int             @default(0)
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
    members         ProjectMember[]
    publishingStages PublishingStage[]
    royalties       Royalty[]
    launchPlans     LaunchPlan[]

    owner     User      @relation("ProjectOwner", fields: [team_lead], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    tasks     AuthorTask[]
}

model ProjectMember {
    id        String      @id @default(uuid())
    userId    String
    projectId String
    user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    project   AuthorProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@unique([userId, projectId]) // prevent duplicate membership
}

model PublishingStage {
    id             String         @id @default(uuid())
    name           String
    description    String?
    order          Int
    authorProjectId String
    createdAt      DateTime       @default(now())
    updatedAt      DateTime       @updatedAt
    authorProject  AuthorProject  @relation(fields: [authorProjectId], references: [id], onDelete: Cascade)
    tasks          AuthorTask[]
}

model AuthorTask {
    id               String          @id @default(uuid())
    projectId        String
    title            String
    description      String?
    status           TaskStatus      @default(TODO)
    type             TaskType        @default(TASK)
    priority         Priority        @default(MEDIUM)
    assigneeId       String
    due_date         DateTime
    publishingStageId String?
    createdAt        DateTime        @default(now())
    updatedAt        DateTime        @updatedAt

    project        AuthorProject   @relation(fields: [projectId], references: [id], onDelete: Cascade)
    assignee       User            @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: Cascade)
    comments       Comment[]
    publishingStage PublishingStage? @relation(fields: [publishingStageId], references: [id])
}

model LaunchPlan {
    id               String    @id @default(uuid())
    authorProjectId  String
    launchDate       DateTime
    marketingBudget  Float
    promotionChannels String[]
    status           String    @default("PLANNING")
    notes            String?
    createdAt        DateTime  @default(now())
    updatedAt        DateTime  @updatedAt

    authorProject AuthorProject @relation(fields: [authorProjectId], references: [id], onDelete: Cascade)
}

model Comment {
    id        String   @id @default(uuid())
    content   String
    userId    String
    taskId    String
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model Royalty {
    id              String    @id @default(uuid())
    authorId        String
    authorProjectId String
    sharePercentage Float
    earnings        Float
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @updatedAt

    author        User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
    authorProject AuthorProject @relation(fields: [authorProjectId], references: [id], onDelete: Cascade)
}
